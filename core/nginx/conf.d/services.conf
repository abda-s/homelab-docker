# ==========================================
# 1. DNS & NETWORK (Pi-hole)
# ==========================================
server {
    listen 80;
    server_name pihole.elwahsh.home;

    location / {
        # Pi-hole is mapped to port 8085 in your compose file
        proxy_pass http://192.168.1.111:8085;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}

# ==========================================
# 1.1. CORE (Dashboard)
# ==========================================
server {
    listen 80;
    server_name dashboard.elwahsh.home;

    location / {
        # Homarr is mapped to port 7575
        proxy_pass http://192.168.1.111:7575;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}

# ==========================================
# 2. PHOTOS (Immich)
# ==========================================
server {
    listen 80;
    server_name immich.elwahsh.home;

    location / {
        # Immich is on port 2283
        proxy_pass http://192.168.1.111:2283;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Websocket Support (Critical for mobile app backup)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Allow large file uploads (50GB) for videos
        client_max_body_size 50G;
    }
}

# ==========================================
# 3. SMARTHOME (Home Assistant)
# ==========================================
server {
    listen 80;
    server_name ha.elwahsh.home;

    location / {
        # Home Assistant is on 'network_mode: host' -> uses port 8123
        proxy_pass http://192.168.1.111:8123;
        proxy_set_header Host $host;
        
        # Websockets (Required for live updates)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

server {
    listen 80;
    server_name esphome.elwahsh.home;

    location / {
        # ESPHome (Host mode) usually defaults to 6052
        proxy_pass http://192.168.1.111:6052;
        proxy_set_header Host $host;
    }
}

# ==========================================
# 4. MEDIA STACK (Jellyfin + *Arrs)
# ==========================================

# Jellyfin
server {
    listen 80;
    server_name jellyfin.elwahsh.home;

    location / {
        # Jellyfin is mapped to 8096
        proxy_pass http://192.168.1.111:8096;
        proxy_set_header Host $host;
        
        # Websockets for live streaming status
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# Sonarr (TV)
server {
    listen 80;
    server_name sonarr.elwahsh.home;

    location / {
        proxy_pass http://192.168.1.111:8989;
        proxy_set_header Host $host;
    }
}

# Radarr (Movies)
server {
    listen 80;
    server_name radarr.elwahsh.home;

    location / {
        proxy_pass http://192.168.1.111:7878;
        proxy_set_header Host $host;
    }
}

# Prowlarr (Indexers)
server {
    listen 80;
    server_name prowlarr.elwahsh.home;

    location / {
        proxy_pass http://192.168.1.111:9696;
        proxy_set_header Host $host;
    }
}

# qBittorrent (Downloads)
server {
    listen 80;
    server_name qbittorrent.elwahsh.home;

    location / {
        proxy_pass http://192.168.1.111:8080;
        proxy_set_header Host $host;
        # Fix for qBittorrent "Unauthorized" error if headers are missing
        proxy_set_header Referer "";
        proxy_set_header Origin "";
    }
}

# Bazarr (Subtitles)
server {
    listen 80;
    server_name bazarr.elwahsh.home;

    location / {
        proxy_pass http://192.168.1.111:6767;
        proxy_set_header Host $host;
    }
}

server {
    listen 80;
    server_name ytp.elwahsh.home;

    # 1. Main Website Config
    location / {
        proxy_pass http://192.168.1.111:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 2. Critical: Dedicated Socket.IO Config
    # This specifically targets the WebSocket connection URL seen in your error
    location /socket.io/ {
        proxy_pass http://192.168.1.111:3333;
        
        # These three lines specifically enable the WebSocket "Upgrade"
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Standard headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Disable buffering so data flows instantly
        proxy_buffering off;
        proxy_cache off;
    }
}